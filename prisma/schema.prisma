generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int               @id @default(autoincrement())
  username        String            @unique
  password        String
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  categories      categories[]
  transactions    transactions[]
  user_categories user_categories[]
  recurring_transactions RecurringTransaction[]

  @@map("users")
}

model categories {
  id               Int               @id @default(autoincrement())
  name             String            @unique
  description      String?
  color            String?
  icon             String?
  created_at       DateTime          @default(now())
  updated_at       DateTime
  parent_id        Int?
  created_by       Int?
  is_default       Boolean           @default(false)
  group            String?            // "income", "essential", "lifestyle", "financial", "other"
  tier             String?            // "most" | "medium" | "less" - for AI prompt ordering
  users            User?             @relation(fields: [created_by], references: [id])
  categories       categories?       @relation("categoriesTocategories", fields: [parent_id], references: [id])
  other_categories categories[]      @relation("categoriesTocategories")
  merchants        merchants[]
  transactions     transactions[]
  user_categories  user_categories[]
  category_keywords category_keywords[]
  recurring_transactions RecurringTransaction[]
}

model merchants {
  id                  Int            @id @default(autoincrement())
  name                String         @unique
  keywords            String[]
  ibans               String[]
  default_category_id Int?
  notes               String?
  is_active           Boolean        @default(true)
  is_potential_recurring Boolean     @default(false)
  created_at          DateTime       @default(now())
  updated_at          DateTime
  categories          categories?    @relation(fields: [default_category_id], references: [id])
  transactions        transactions[]
  recurring_transactions RecurringTransaction[]
}

model transactions {
  id                 Int             @id @default(autoincrement())
  date               DateTime
  merchantName       String
  iban               String
  counterparty_iban  String?
  is_debit           Boolean         @default(true)
  amount             Decimal         @db.Decimal(10, 2)
  type               TransactionType
  description        String
  category_id        Int?
  is_category_manual Boolean         @default(false)
  category_confidence Float?
  is_recurring       Boolean?
  created_at         DateTime        @default(now())
  updated_at         DateTime
  user_id            Int
  merchant_id        Int?
  // Data cleaning fields
  cleaned_merchant_name    String?
  normalized_description   String?
  categories         categories?     @relation(fields: [category_id], references: [id])
  merchants          merchants?      @relation(fields: [merchant_id], references: [id])
  users              User            @relation(fields: [user_id], references: [id], onDelete: Cascade)
  category_keywords  category_keywords[]
  recurring_transaction_id Int?
  recurring_transaction    RecurringTransaction? @relation(fields: [recurring_transaction_id], references: [id])

  @@index([date])
  @@index([user_id, category_id])
  @@index([user_id, date])
  @@index([user_id, merchant_id])
  @@index([recurring_transaction_id])
}

model RecurringTransaction {
  id                 Int            @id @default(autoincrement())
  user_id            Int
  name               String
  amount             Decimal        @db.Decimal(10, 2)
  interval           String         // "monthly", "weekly", "quarterly", "yearly", "4-weekly"
  type               String?        // "subscription", "variable_cost", "salary", "tax", "transfer"
  status             String         @default("active") // "active", "inactive"
  merchant_id        Int?
  category_id        Int?
  next_expected_date DateTime?
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt
  
  users              User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  merchants          merchants?     @relation(fields: [merchant_id], references: [id])
  categories         categories?    @relation(fields: [category_id], references: [id])
  transactions       transactions[]

  @@map("recurring_transactions")
  @@index([user_id])
  @@index([status])
}

model user_categories {
  id          Int        @id @default(autoincrement())
  user_id     Int
  category_id Int
  is_active   Boolean    @default(true)
  sort_order  Int        @default(0)
  created_at  DateTime   @default(now())
  updated_at  DateTime
  categories  categories @relation(fields: [category_id], references: [id], onDelete: Cascade)
  users       User       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, category_id])
  @@index([user_id, is_active])
}

model category_keywords {
  id                  Int          @id @default(autoincrement())
  category_id         Int
  keyword             String
  source              String       @default("manual") // "manual" | "ai"
  source_transaction_id Int?
  confidence          Float?
  created_at          DateTime     @default(now())
  categories          categories   @relation(fields: [category_id], references: [id], onDelete: Cascade)
  transactions        transactions? @relation(fields: [source_transaction_id], references: [id])

  @@unique([category_id, keyword])
  @@index([category_id])
  @@index([keyword])
}

enum TransactionType {
  Payment
  Transfer
  DirectDebit
  Deposit
  Withdrawal
  Refund
  Fee
  Interest
  Other
}
