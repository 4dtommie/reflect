generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         Int                       @id @default(autoincrement())
  username                   String                    @unique
  password                   String
  createdAt                  DateTime                  @default(now()) @map("created_at")
  updatedAt                  DateTime                  @updatedAt @map("updated_at")
  daily_visit_count          Int                       @default(0)
  last_active_at             DateTime                  @default(now())
  login_streak               Int                       @default(0)
  streak_updated_at          DateTime?
  bank_accounts              BankAccount[]
  categories                 categories[]
  chat_conversations         ChatConversation[]
  recurring_transactions     RecurringTransaction[]
  transactions               transactions[]
  user_categories            user_categories[]
  variable_spending_patterns VariableSpendingPattern[]

  @@map("users")
}

model BankAccount {
  id             Int      @id @default(autoincrement())
  user_id        Int
  iban           String
  name           String
  type           String?
  is_own_account Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  user           User     @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, iban])
  @@index([user_id])
  @@map("bank_accounts")
}

model categories {
  id                         Int                       @id @default(autoincrement())
  name                       String                    @unique
  description                String?
  color                      String?
  icon                       String?
  created_at                 DateTime                  @default(now())
  updated_at                 DateTime
  parent_id                  Int?
  created_by                 Int?
  is_default                 Boolean                   @default(false)
  group                      String?
  tier                       String?
  is_variable_spending       Boolean                   @default(false)
  users                      User?                     @relation(fields: [created_by], references: [id])
  categories                 categories?               @relation("categoriesTocategories", fields: [parent_id], references: [id])
  other_categories           categories[]              @relation("categoriesTocategories")
  category_keywords          category_keywords[]
  merchants                  merchants[]
  recurring_transactions     RecurringTransaction[]
  transactions               transactions[]
  user_categories            user_categories[]
  variable_spending_patterns VariableSpendingPattern[]
}

model merchants {
  id                     Int                    @id @default(autoincrement())
  name                   String                 @unique
  keywords               String[]
  ibans                  String[]
  default_category_id    Int?
  notes                  String?
  is_active              Boolean                @default(true)
  created_at             DateTime               @default(now())
  updated_at             DateTime
  is_potential_recurring Boolean?
  categories             categories?            @relation(fields: [default_category_id], references: [id])
  recurring_transactions RecurringTransaction[]
  transactions           transactions[]
}

model transactions {
  id                             Int                   @id @default(autoincrement())
  date                           DateTime
  merchantName                   String
  iban                           String
  counterparty_iban              String?
  is_debit                       Boolean               @default(true)
  amount                         Decimal               @db.Decimal(10, 2)
  type                           TransactionType
  description                    String
  category_id                    Int?
  is_category_manual             Boolean               @default(false)
  is_recurring                   Boolean?
  created_at                     DateTime              @default(now())
  updated_at                     DateTime
  user_id                        Int
  merchant_id                    Int?
  category_confidence            Float?
  cleaned_merchant_name          String?
  normalized_description         String?
  recurring_transaction_id       Int?
  last_categorization_attempt_at DateTime?
  category_keywords              category_keywords[]
  categories                     categories?           @relation(fields: [category_id], references: [id])
  merchants                      merchants?            @relation(fields: [merchant_id], references: [id])
  recurring_transaction          RecurringTransaction? @relation(fields: [recurring_transaction_id], references: [id])
  users                          User                  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([user_id, category_id])
  @@index([user_id, date])
  @@index([user_id, merchant_id])
  @@index([recurring_transaction_id])
}

model RecurringTransaction {
  id                 Int            @id @default(autoincrement())
  user_id            Int
  name               String
  amount             Decimal        @db.Decimal(10, 2)
  interval           String
  status             String         @default("active")
  merchant_id        Int?
  category_id        Int?
  next_expected_date DateTime?
  created_at         DateTime       @default(now())
  updated_at         DateTime       @updatedAt
  type               String?
  is_debit           Boolean        @default(true)
  categories         categories?    @relation(fields: [category_id], references: [id])
  merchants          merchants?     @relation(fields: [merchant_id], references: [id])
  users              User           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  transactions       transactions[]

  @@index([user_id])
  @@index([status])
  @@map("recurring_transactions")
}

model VariableSpendingPattern {
  id                 Int        @id @default(autoincrement())
  user_id            Int
  category_id        Int
  category_name      String
  monthly_average    Decimal    @db.Decimal(10, 2)
  visits_per_month   Decimal    @db.Decimal(5, 2)
  average_per_visit  Decimal    @db.Decimal(10, 2)
  total_spent        Decimal    @db.Decimal(12, 2)
  total_transactions Int
  unique_merchants   Int
  top_merchants      Json?
  min_amount         Decimal    @db.Decimal(10, 2)
  max_amount         Decimal    @db.Decimal(10, 2)
  first_transaction  DateTime
  last_transaction   DateTime
  status             String     @default("active")
  created_at         DateTime   @default(now())
  updated_at         DateTime   @updatedAt
  categories         categories @relation(fields: [category_id], references: [id])
  users              User       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, category_id])
  @@index([user_id])
  @@index([status])
  @@map("variable_spending_patterns")
}

model user_categories {
  id          Int        @id @default(autoincrement())
  user_id     Int
  category_id Int
  is_active   Boolean    @default(true)
  sort_order  Int        @default(0)
  created_at  DateTime   @default(now())
  updated_at  DateTime
  categories  categories @relation(fields: [category_id], references: [id], onDelete: Cascade)
  users       User       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, category_id])
  @@index([user_id, is_active])
}

model category_keywords {
  id                    Int           @id @default(autoincrement())
  category_id           Int
  keyword               String
  source                String        @default("manual")
  source_transaction_id Int?
  confidence            Float?
  created_at            DateTime      @default(now())
  categories            categories    @relation(fields: [category_id], references: [id], onDelete: Cascade)
  transactions          transactions? @relation(fields: [source_transaction_id], references: [id])

  @@unique([category_id, keyword])
  @@index([category_id])
  @@index([keyword])
}

model InsightDefinition {
  id                 String              @id
  category           String
  priority           Int                 @default(50)
  trigger            String
  trigger_params     Json?
  message_template   String
  icon               String?
  action_label       String?
  action_href        String?
  contexts           String[]
  is_active          Boolean             @default(true)
  created_at         DateTime            @default(now())
  updated_at         DateTime            @updatedAt
  cooldown_hours     Int                 @default(0)
  related_insight_id String?
  non_exclusive      Boolean             @default(false)
  description        String?
  name               String?
  related_insight    InsightDefinition?  @relation("RelatedInsights", fields: [related_insight_id], references: [id])
  related_to         InsightDefinition[] @relation("RelatedInsights")

  @@map("insight_definitions")
}

model ChatConversation {
  id         Int           @id @default(autoincrement())
  user_id    Int
  title      String?
  created_at DateTime      @default(now())
  updated_at DateTime      @updatedAt
  users      User          @relation(fields: [user_id], references: [id], onDelete: Cascade)
  messages   ChatMessage[]

  @@index([user_id])
  @@map("chat_conversations")
}

model ChatMessage {
  id              Int              @id @default(autoincrement())
  conversation_id Int
  role            String
  content         String
  insight_id      String?
  action_buttons  Json?
  created_at      DateTime         @default(now())
  data            Json?
  conversation    ChatConversation @relation(fields: [conversation_id], references: [id], onDelete: Cascade)

  @@index([conversation_id])
  @@map("chat_messages")
}

enum TransactionType {
  Payment
  Transfer
  DirectDebit
  Deposit
  Withdrawal
  Refund
  Fee
  Interest
  Other
}
