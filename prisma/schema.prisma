generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id              Int               @id @default(autoincrement())
  username        String            @unique
  password        String
  createdAt       DateTime          @default(now()) @map("created_at")
  updatedAt       DateTime          @updatedAt @map("updated_at")
  categories      categories[]
  transactions    transactions[]
  user_categories user_categories[]

  @@map("users")
}

model categories {
  id               Int               @id @default(autoincrement())
  name             String            @unique
  description      String?
  color            String?
  icon             String?
  keywords         String[]
  created_at       DateTime          @default(now())
  updated_at       DateTime
  parent_id        Int?
  created_by       Int?
  is_default       Boolean           @default(false)
  users            User?             @relation(fields: [created_by], references: [id])
  categories       categories?       @relation("categoriesTocategories", fields: [parent_id], references: [id])
  other_categories categories[]      @relation("categoriesTocategories")
  merchants        merchants[]
  transactions     transactions[]
  user_categories  user_categories[]
}

model merchants {
  id                  Int            @id @default(autoincrement())
  name                String         @unique
  keywords            String[]
  ibans               String[]
  default_category_id Int?
  notes               String?
  is_active           Boolean        @default(true)
  created_at          DateTime       @default(now())
  updated_at          DateTime
  categories          categories?    @relation(fields: [default_category_id], references: [id])
  transactions        transactions[]
}

model transactions {
  id                 Int             @id @default(autoincrement())
  date               DateTime
  merchantName       String
  iban               String
  counterparty_iban  String?
  is_debit           Boolean         @default(true)
  amount             Decimal         @db.Decimal(10, 2)
  type               TransactionType
  description        String
  category_id        Int?
  is_category_manual Boolean         @default(false)
  is_recurring       Boolean?
  created_at         DateTime        @default(now())
  updated_at         DateTime
  user_id            Int
  merchant_id        Int?
  categories         categories?     @relation(fields: [category_id], references: [id])
  merchants          merchants?      @relation(fields: [merchant_id], references: [id])
  users              User            @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([date])
  @@index([user_id, category_id])
  @@index([user_id, date])
  @@index([user_id, merchant_id])
}

model user_categories {
  id          Int        @id @default(autoincrement())
  user_id     Int
  category_id Int
  is_active   Boolean    @default(true)
  sort_order  Int        @default(0)
  created_at  DateTime   @default(now())
  updated_at  DateTime
  categories  categories @relation(fields: [category_id], references: [id], onDelete: Cascade)
  users       User       @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, category_id])
  @@index([user_id, is_active])
}

enum TransactionType {
  Payment
  Transfer
  DirectDebit
  Deposit
  Withdrawal
  Refund
  Fee
  Interest
  Other
}
